/**
 * Deferred
 * Version: 1.4.0
 * Author: Dmitry Shimkin <dmitryshimkin@gmail.com>
 * License: MIT
 * https://github.com/dmitryshimkin/deferred
 */
!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define(factory):global.Deferred=factory()}(this,function(){"use strict";function getPromiseStatus(promise){return promise[PROMISE_STATUS_KEY]}function getPromiseValue(promise){return promise[PROMISE_VALUE_KEY]}function indexOf(promises,promise){for(var i=promises.length;i--;)if(promises[i]===promise)return i;return-1}function isDeferred(arg){return arg instanceof Deferred$1}function processChild(parentPromise,child){var x,error,parentValue=getPromiseValue(parentPromise),isResolved=parentPromise[PROMISE_STATUS_KEY]===PROMISE_RESOLVED,fn=isResolved?child.onResolve:child.onReject,hasHandler="function"==typeof fn;if(!hasHandler)return void(isResolved?child.deferred.resolve(parentValue):child.deferred.reject(parentValue));try{x=fn.call(child.ctx,parentValue)}catch(err){error=err}void 0!==error?child.deferred.reject(error):child.deferred.resolve(x)}function setPromiseStatus(promise,status){promise[PROMISE_STATUS_KEY]=status}function setPromiseValue(promise,value){promise[PROMISE_VALUE_KEY]=value}function Promise(){setPromiseValue(this,void 0),setPromiseStatus(this,PROMISE_PENDING),this.cid="cid"+counter,counter++}function always(arg,ctx){return isDeferred(arg)?this.done(function(value){arg.resolve(value)}).fail(function(reason){arg.reject(reason)}):this.done(arg,ctx).fail(arg,ctx),this}function done(arg,ctx){var status=getPromiseStatus(this),isDfd=isDeferred(arg);return status===PROMISE_RESOLVED?(isDfd?arg.resolve(getPromiseValue(this)):arg.call(ctx,getPromiseValue(this)),this):(status===PROMISE_PENDING&&(isDfd?this.done(function(value){arg.resolve.call(arg,value)}):addCallback(this,"_doneCallbacks",{fn:arg,ctx:ctx})),this)}function fail(arg,ctx){var status=getPromiseStatus(this),isDfd=isDeferred(arg);return status===PROMISE_REJECTED?(isDfd?arg.reject(getPromiseValue(this)):arg.call(ctx,getPromiseValue(this)),this):(status===PROMISE_PENDING&&(isDfd?this.fail(function(reason){arg.reject(reason)}):addCallback(this,"_failCallbacks",{fn:arg,ctx:ctx})),this)}function isPending(){var status=getPromiseStatus(this);return status===PROMISE_PENDING||status===PROMISE_LOCKED}function isRejected(){return getPromiseStatus(this)===PROMISE_REJECTED}function isResolved(){return getPromiseStatus(this)===PROMISE_RESOLVED}function then(onResolve,onReject,argCtx){var argsCount=arguments.length;return 2===argsCount&&("object"==typeof onReject?(argCtx=onReject,onReject=null):argCtx=this),_then(this,onResolve,onReject,argCtx)}function _then(parentPromise,onResolve,onReject,ctx){var childDeferred=new Deferred$1;if(parentPromise.isResolved()&&"function"!=typeof onResolve)return childDeferred.resolve(getPromiseValue(parentPromise)),childDeferred.promise;if(parentPromise.isRejected()&&"function"!=typeof onReject)return childDeferred.reject(getPromiseValue(parentPromise)),childDeferred.promise;var child=new ChildPromise(childDeferred,onResolve,onReject,ctx);return parentPromise.isPending()?addChild(parentPromise,child):processChild(parentPromise,child),childDeferred.promise}function ChildPromise(dfd,onResolve,onReject,ctx){this.deferred=dfd,this.onResolve=onResolve,this.onReject=onReject,this.ctx=ctx}function addChild(parentPromise,child){parentPromise._children?parentPromise._children.push(child):parentPromise._children=[child]}function _catch(onReject,ctx){return this.then(null,onReject,ctx)}function addCallback(promise,key,obj){promise[key]?promise[key].push(obj):promise[key]=[obj]}function Deferred$1(){this.promise=new Promise}function reject(reason){return getPromiseStatus(this.promise)!==PROMISE_PENDING?this:rejectWithReason(this,reason)}function resolve(x){var dfd=this,promise=this.promise;return getPromiseStatus(promise)!==PROMISE_PENDING?dfd:x===this||x===promise?rejectWithSameArgError(dfd):x instanceof Promise?resolveWithPromise(dfd,x):resolveWithValue(dfd,x)}function rejectWithReason(dfd,reason){var promise=dfd.promise;return setPromiseStatus(promise,PROMISE_REJECTED),setPromiseValue(promise,reason),runCallbacks(promise._failCallbacks,reason),processChildren(dfd),cleanUpPromise(promise),dfd}function rejectWithSameArgError(dfd){var err=new TypeError("Promise and argument refer to the same object");return dfd.reject(err),dfd}function resolveWithPromise(dfd,promise){return lockPromise(dfd.promise),promise.done(function(xValue){setPromiseStatus(dfd.promise,PROMISE_PENDING),resolveWithValue(dfd,xValue)}).fail(function(xReason){setPromiseStatus(dfd.promise,PROMISE_PENDING),rejectWithReason(dfd,xReason)}),dfd}function resolveWithValue(dfd,value){return setPromiseStatus(dfd.promise,PROMISE_RESOLVED),setPromiseValue(dfd.promise,value),runCallbacks(dfd.promise._doneCallbacks,value),processChildren(dfd),cleanUpPromise(dfd.promise),dfd}function processChildren(dfd){var children=dfd.promise._children;if(children)for(var i=0;i<children.length;i++)processChild(dfd.promise,children[i])}function runCallbacks(callbacks,value){if(callbacks)for(var i=0;i<callbacks.length;i++)runCallback(callbacks[i],value)}function runCallback(callback,value){try{callback.fn.call(callback.ctx,value)}catch(err){throwAsync(err)}}function throwAsync(err){setTimeout(function(){throw err},0)}function isPromise(arg){return arg instanceof Promise}function isThenable(arg){return null!==arg&&"object"==typeof arg&&"function"==typeof arg.then}function cleanUpPromise(promise){promise._doneCallbacks=null,promise._failCallbacks=null}function lockPromise(promise){setPromiseStatus(promise,PROMISE_LOCKED)}function all(promises){var dfd=new Deferred$1;if(!promises)return dfd.promise;var i,l,values=new Array(promises.length),pendingCount=0;for(i=0,l=promises.length;l>i;i++){if(promises[i].isRejected())return dfd.reject(getPromiseValue(promises[i])),dfd.promise;promises[i].isResolved()?values[i]=getPromiseValue(promises[i]):(pendingCount++,promises[i].fail(function(reason){dfd.reject(reason)}),promises[i].done(function(value){var index=indexOf(promises,this);values[index]=value,pendingCount--,0===pendingCount&&dfd.resolve(values)},promises[i]))}return pendingCount?dfd.promise:(dfd.resolve(values),dfd.promise)}function race(promises){var dfd=new Deferred$1;if(!promises)return dfd.promise;var i,l,reasons=new Array(promises.length),pendingCount=0;for(i=0,l=promises.length;l>i;i++){if(promises[i].isResolved())return dfd.resolve(getPromiseValue(promises[i])),dfd.promise;promises[i].isRejected()?reasons[i]=getPromiseValue(promises[i]):(pendingCount++,promises[i].done(function(value){dfd.resolve(value)}),promises[i].fail(function(reason){var index=indexOf(promises,this);reasons[index]=reason,pendingCount--,0===pendingCount&&dfd.reject(reasons)},promises[i]))}return pendingCount?dfd.promise:(dfd.reject(reasons),dfd.promise)}function reject$1(reason){var dfd=new Deferred$1;return dfd.reject(reason),dfd.promise}function resolve$1(x){if(Deferred$1.isPromise(x))return x;if(Deferred$1.isDeferred(x))return x.promise;var dfd=new Deferred$1;return Deferred$1.isThenable(x)?x.then(function(val){dfd.resolve(val)},function(reason){dfd.reject(reason)}):dfd.resolve(x),dfd.promise}var PROMISE_STATUS_KEY="[[PromiseStatus]]",PROMISE_VALUE_KEY="[[PromiseValue]]",PROMISE_LOCKED="locked",PROMISE_PENDING="pending",PROMISE_REJECTED="rejected",PROMISE_RESOLVED="resolved",counter=0;return Promise.prototype.always=always,Promise.prototype.done=done,Promise.prototype.fail=fail,Promise.prototype["catch"]=_catch,Promise.prototype.isPending=isPending,Promise.prototype.isResolved=isResolved,Promise.prototype.isRejected=isRejected,Promise.prototype.then=then,Deferred$1.isDeferred=isDeferred,Deferred$1.isPromise=isPromise,Deferred$1.isThenable=isThenable,Deferred$1.prototype.reject=reject,Deferred$1.prototype.resolve=resolve,Deferred$1.all=all,Deferred$1.race=race,Deferred$1.reject=reject$1,Deferred$1.resolve=resolve$1,Deferred$1});