/**
 * Deferred
 * Version: 1.1.0
 * Author: Dmitry Shimkin <dmitryshimkin@gmail.com>
 * License: MIT
 * https://github.com/dmitryshimkin/deferred
 */
!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.Deferred=t()}(this,function(){"use strict";function e(){this.value=void 0,this._state=0}function t(e,t,o,u){var c=new s;if(e.isResolved()&&"function"!=typeof t)return c.resolve(e.value),c.promise;if(e.isRejected()&&"function"!=typeof o)return c.reject(e.value),c.promise;var f=new n(c,t,o,u);return e.isPending()?r(e,f):i(e,f),c.promise}function n(e,t,n,r){this.deferred=e,this.onResolve=t,this.onReject=n,this.ctx=r}function r(e,t){e._children?e._children.push(t):e._children=[t]}function i(e,t){var n,r,i=e.value,o=2===e._state,s=o?t.onResolve:t.onReject;try{n=s.call(t.ctx,i)}catch(u){r=u}void 0!==r?t.deferred.reject(r):t.deferred.resolve(n)}function o(e,t,n){e[t]?e[t].push(n):e[t]=[n]}function s(){this.promise=new e}function u(e,t){var n=e.promise;return n._state=3,n.value=t,h(n._failCallbacks,t),l(e),p(n),e}function c(e){var t=new TypeError("Promise and argument refer to the same object");return e.reject(t),e}function f(e,t){return v(e.promise),t.done(function(t){e.promise._state=0,a(e,t)}).fail(function(t){e.promise._state=0,u(e,t)}),e}function a(e,t){return e.promise._state=2,e.promise.value=t,h(e.promise._doneCallbacks,t),l(e),p(e.promise),e}function l(e){var t=e.promise._children;if(t)for(var n=0;n<t.length;n++)i(e.promise,t[n])}function h(e,t){var n;if(e)for(var r=0;r<e.length;r++)n=e[r],n.fn.call(n.ctx,t)}function p(e){e._doneCallbacks=null,e._failCallbacks=null}function v(e){e._state=1}function d(e,t){for(var n=e.length;n--;)if(e[n]===t)return n;return-1}return e.prototype.always=function(e,t){return e instanceof s?this.done(function(t){e.resolve(t)}).fail(function(t){e.reject(t)}):this.done(e,t).fail(e,t),this},e.prototype.done=function(e,t){var n=this._state,r=e instanceof s;return 2===n?(r?e.resolve(this.value):e.call(t,this.value),this):(0===n&&(r?this.done(function(t){e.resolve.call(e,t)}):o(this,"_doneCallbacks",{fn:e,ctx:t})),this)},e.prototype.fail=function(e,t){var n=this._state,r=e instanceof s;return 3===n?(r?e.reject(this.value):e.call(t,this.value),this):(0===n&&(r?this.fail(function(t){e.reject(t)}):o(this,"_failCallbacks",{fn:e,ctx:t})),this)},e.prototype.isPending=function(){return this._state<=1},e.prototype.isRejected=function(){return 3===this._state},e.prototype.isResolved=function(){return 2===this._state},e.prototype.then=function(e,n,r){var i=arguments.length;return 2===i&&("object"==typeof n?(r=n,n=null):r=this),t(this,e,n,r)},e.prototype["catch"]=function(e,t){return this.then(null,e,t)},s.prototype.reject=function(e){return 0!==this.promise._state?this:u(this,e)},s.prototype.resolve=function(t){var n=this,r=this.promise;return 0!==r._state?n:t===this||t===r?c(n):t instanceof e?f(n,t):a(n,t)},s.isPromise=function(t){return t instanceof e},s.isDeferred=function(e){return e instanceof s},s.isThenable=function(e){return null!==e&&"object"==typeof e&&"function"==typeof e.then},s.all=function(e){var t=new s;if(!e)return t.promise;var n,r,i=new Array(e.length),o=0;for(n=0,r=e.length;r>n;n++){if(e[n].isRejected())return t.reject(e[n].value),t.promise;e[n].isResolved()?i[n]=e[n].value:(o++,e[n].fail(function(e){t.reject(e)}),e[n].done(function(n){var r=d(e,this);i[r]=n,o--,0===o&&t.resolve(i)},e[n]))}return o?t.promise:(t.resolve(i),t.promise)},s.race=function(e){var t=new s;if(!e)return t.promise;var n,r,i=new Array(e.length),o=0;for(n=0,r=e.length;r>n;n++){if(e[n].isResolved())return t.resolve(e[n].value),t.promise;e[n].isRejected()?i[n]=e[n].value:(o++,e[n].done(function(e){t.resolve(e)}),e[n].fail(function(n){var r=d(e,this);i[r]=n,o--,0===o&&t.reject(i)},e[n]))}return o?t.promise:(t.reject(i),t.promise)},s.reject=function(e){var t=new s;return t.reject(e),t.promise},s.resolve=function(e){if(s.isPromise(e))return e;if(s.isDeferred(e))return e.promise;var t=new s;return s.isThenable(e)?e.then(function(e){t.resolve(e)},function(e){t.reject(e)}):t.resolve(e),t.promise},s});