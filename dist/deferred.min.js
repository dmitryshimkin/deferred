/**
 * Deferred
 * Version: 1.0.1
 * Author: Dmitry Shimkin <dmitryshimkin@gmail.com>
 * License: MIT
 * https://github.com/dmitryshimkin/deferred
 */
!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.Deferred=t()}(this,function(){"use strict";function e(){this.value=void 0,this._state=0}function t(e,t,n){e.hasOwnProperty(t)||(e[t]=[]),e[t].push(n)}function n(){this.promise=new e}function r(e){e[0]=null,e[1]=null}function i(e,t){var n;if(e)for(var r=0,i=e.length;i>r;r++)n=e[r],n.fn.call(n.ctx,t)}function o(e,t){for(var n=e.length;n--;)if(e[n]===t)return n;return-1}return e.prototype.always=function(e,t){return e instanceof n?this.done(function(t){e.resolve(t)}).fail(function(t){e.reject(t)}):this.done(e,t).fail(e,t),this},e.prototype.done=function(e,r){var i=this._state,o=e instanceof n;return void 0===r&&(r=this),2===i?(o?e.resolve(this.value):e.call(r,this.value),this):(0===i&&(o?this.done(function(t){e.resolve.call(e,t)}):t(this,1,{fn:e,ctx:r})),this)},e.prototype.fail=function(e,r){var i=this._state,o=e instanceof n;return void 0===r&&(r=this),3===i?(o?e.reject(this.value):e.call(r,this.value),this):(0===i&&(o?this.fail(function(t){e.reject(t)}):t(this,0,{fn:e,ctx:r})),this)},e.prototype.isPending=function(){return this._state<=1},e.prototype.isRejected=function(){return 3===this._state},e.prototype.isResolved=function(){return 2===this._state},e.prototype.then=function(e,t,r){var i,o=arguments[arguments.length-1],s=2===this._state,u=3===this._state,f=new n,c="function";if(i=typeof o!==c?o:r,void 0===i&&(i=this),typeof e===c)this.done(function(t){var n,r;try{n=e.call(i,t)}catch(o){r=o}void 0!==r?f.reject(r):f.resolve(n)});else if(s)return f.resolve(this.value),f.promise;return typeof t===c?this.fail(function(e){var n,r;try{n=t.call(i,e)}catch(o){r=o}void 0!==r?f.reject(r):f.resolve(n)}):u&&f.reject(this.value),f.promise},e.prototype["catch"]=function(e,t){return this.then(null,e,t)},e.prototype.valueOf=function(){return this},n.prototype.reject=function(e){return 0!==this.promise._state?this:(this.promise._state=3,this.promise.value=e,i(this.promise[0],e),r(this.promise),this)},n.prototype.resolve=function(t){var n=this,o=this.promise;if(0!==o._state)return this;if(t===this||t===o){var s=new TypeError("Promise and argument refer to the same object");return this.reject(s),this}return t instanceof e?(o._state=1,t.done(function(e){o._state=0,n.resolve(e)}).fail(function(e){o._state=0,n.reject(e)}),this):(o._state=2,o.value=t,i(o[1],o.value),r(o),this)},n.isPromise=function(t){return t instanceof e},n.isDeferred=function(e){return e instanceof n},n.isThenable=function(e){return null!==e&&"object"==typeof e&&"function"==typeof e.then},n.all=function(e){var t=new n;if(!e)return t.promise;var r,i,s=new Array(e.length),u=0;for(r=0,i=e.length;i>r;r++){if(e[r].isRejected())return t.reject(e[r].value),t.promise;e[r].isResolved()?s[r]=e[r].value:(u++,e[r].fail(function(e){t.reject(e)}),e[r].done(function(n){var r=o(e,this);s[r]=n,u--,0===u&&t.resolve(s)},e[r]))}return u?t.promise:(t.resolve(s),t.promise)},n.race=function(e){var t=new n;if(!e)return t.promise;var r,i,s=new Array(e.length),u=0;for(r=0,i=e.length;i>r;r++){if(e[r].isResolved())return t.resolve(e[r].value),t.promise;e[r].isRejected()?s[r]=e[r].value:(u++,e[r].done(function(e){t.resolve(e)}),e[r].fail(function(n){var r=o(e,this);s[r]=n,u--,0===u&&t.reject(s)},e[r]))}return u?t.promise:(t.reject(s),t.promise)},n.reject=function(e){var t=new n;return t.reject(e),t.promise},n.resolve=function(e){if(n.isPromise(e))return e;if(n.isDeferred(e))return e.promise;var t=new n;return n.isThenable(e)?e.then(function(e){t.resolve(e)},function(e){t.reject(e)}):t.resolve(e),t.promise},n});