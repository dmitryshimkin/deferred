/**
 * Deferred
 * Version: 1.0.1
 * Author: Dmitry Shimkin <dmitryshimkin@gmail.com>
 * License: MIT
 * https://github.com/dmitryshimkin/deferred
 */
!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.Deferred=t()}(this,function(){"use strict";function e(e,t,n){e.hasOwnProperty(t)||(e[t]=[]),e[t].push(n)}function t(e){e[0]=null,e[1]=null}function n(e,t){var n;if(e)for(var r=0,i=e.length;i>r;r++)n=e[r],n.fn.call(n.ctx,t)}var r=function(){this.value=void 0,this._state=0};r.prototype.always=function(e,t){return e instanceof i?this.done(function(t){e.resolve(t)}).fail(function(t){e.reject(t)}):this.done(e,t).fail(e,t),this},r.prototype.done=function(t,n){var r=this._state,o=t instanceof i;return void 0===n&&(n=this),2===r?(o?t.resolve(this.value):t.call(n,this.value),this):(0===r&&(o?this.done(function(e){t.resolve.call(t,e)}):e(this,1,{fn:t,ctx:n})),this)},r.prototype.fail=function(t,n){var r=this._state,o=t instanceof i;return void 0===n&&(n=this),3===r?(o?t.reject(this.value):t.call(n,this.value),this):(0===r&&(o?this.fail(function(e){t.reject(e)}):e(this,0,{fn:t,ctx:n})),this)},r.prototype.isPending=function(){return this._state<=1},r.prototype.isRejected=function(){return 3===this._state},r.prototype.isResolved=function(){return 2===this._state},r.prototype.then=function(e,t,n){var r,o=arguments[arguments.length-1],s=2===this._state,u=3===this._state,f=new i,a="function";if(r=typeof o!==a?o:n,void 0===r&&(r=this),typeof e===a)this.done(function(t){var n,i;try{n=e.call(r,t)}catch(o){i=o}void 0!==i?f.reject(i):f.resolve(n)});else if(s)return f.resolve(this.value),f.promise;return typeof t===a?this.fail(function(e){var n,i;try{n=t.call(r,e)}catch(o){i=o}void 0!==i?f.reject(i):f.resolve(n)}):u&&f.reject(this.value),f.promise},r.prototype["catch"]=function(e,t){return this.then(null,e,t)},r.prototype.valueOf=function(){return this};var i=function(){this.promise=new r};return i.prototype.reject=function(e){return 0!==this.promise._state?this:(this.promise._state=3,this.promise.value=e,n(this.promise[0],e),t(this.promise),this)},i.prototype.resolve=function(e){var i=this,o=this.promise;if(0!==o._state)return this;if(e===this||e===o){var s=new TypeError("Promise and argument refer to the same object");return this.reject(s),this}return e instanceof r?(o._state=1,e.done(function(e){o._state=0,i.resolve(e)}).fail(function(e){o._state=0,i.reject(e)}),this):(o._state=2,o.value=e,n(o[1],o.value),t(o),this)},i.isPromise=function(e){return e instanceof r},i.isDeferred=function(e){return e instanceof i},i.isThenable=function(e){return null!==e&&"object"==typeof e&&"function"==typeof e.then},i.all=function(e){var t=new i;if(!e)return t.promise;var n,r,o=new Array(e.length),s=0;for(n=0,r=e.length;r>n;n++){if(e[n].isRejected())return t.reject(e[n].value),t.promise;e[n].isResolved()?o[n]=e[n].value:(s++,e[n].fail(function(e){t.reject(e)}),e[n].done(function(n){var r=i.all.indexOf(e,this);o[r]=n,s--,0===s&&t.resolve(o)},e[n]))}return s?t.promise:(t.resolve(o),t.promise)},i.all.indexOf=function(e,t){for(var n=e.length;n--;)if(e[n]===t)return n;return-1},i.race=function(e){var t=new i;if(!e)return t.promise;var n,r,o=new Array(e.length),s=0;for(n=0,r=e.length;r>n;n++){if(e[n].isResolved())return t.resolve(e[n].value),t.promise;e[n].isRejected()?o[n]=e[n].value:(s++,e[n].done(function(e){t.resolve(e)}),e[n].fail(function(n){var r=i.all.indexOf(e,this);o[r]=n,s--,0===s&&t.reject(o)},e[n]))}return s?t.promise:(t.reject(o),t.promise)},i.reject=function(e){var t=new i;return t.reject(e),t.promise},i.resolve=function(e){if(i.isPromise(e))return e;if(i.isDeferred(e))return e.promise;var t=new i;return i.isThenable(e)?e.then(function(e){t.resolve(e)},function(e){t.reject(e)}):t.resolve(e),t.promise},i});