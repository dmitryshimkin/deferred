(function(h){var m=function(){this.value=[];this._state=0;this._callbacks={done:[],fail:[]}},c=m.prototype;c.always=function(){return this};c.done=function(a,b){var f=this._state;b=b!==h?b:this;0===f?this._callbacks.done.push({fn:a,ctx:b}):1===f&&a.apply(b,this.value);return this};c.fail=function(a,b){var f=this._state;b=b!==h?b:this;0===f?this._callbacks.fail.push({fn:a,ctx:b}):2===f&&a.apply(b,this.value);return this};c.isPending=function(){return 0===this._state};c.isRejected=function(){return 2===
  this._state};c.isResolved=function(){return 1===this._state};c.then=function(a,b,f){var d=arguments[arguments.length-1],e=new g;d&&"function"!==typeof d&&(f=d);f=f!==h?f:this;"function"===typeof a?this.done(function(){var b,d;try{b=a.apply(f,arguments)}catch(c){d=c}d!==h?e.reject(d):b!==h&&e.resolve(b)}):1===this._state&&e.resolve.apply(e,this.value);"function"===typeof b?this.fail(function(){var a,d;try{a=b.apply(f,arguments)}catch(c){d=c}d!==h?e.reject(d):a!==h&&e.resolve(a)}):2===this._state&&
  e.reject.apply(e,this.value);return e.promise};var r=0,g=function(){this.uid=r++;this.promise=new m;this.promise.uid=this.uid},c=g.prototype;c.reject=function(){var a=this.promise;if(0!==a._state)return this;a._state=2;a.value=arguments;for(var b=a._callbacks.fail,f,d=0,e=b.length;d<e;d++)f=b[d],f.fn.apply(f.ctx,a.value);return this};c.resolve=function(a){var b=this.promise,f,d,e,c,l,h=this;if(0!==b._state)return this;if(a===this||a===b)return d=new TypeError("Promise and argument refer to the same object"),
  this.reject(d),this;var k=a instanceof g,n=a instanceof m,q=k||n,p=typeof a;if(null!==a&&("object"===p||"function"===p))try{var r=a.then}catch(s){return this.reject(s),this}p="function"===typeof r;n=n?0===a._state:k?0===a.promise._state:!1;!p||q&&!n||(d=function(){if(0!==b._state)return!1;q&&(f=k?a.promise.value:a.value);b._state=1;b.value=f||Array.prototype.slice.call(arguments);var d,e=b._callbacks.done;c=0;for(l=e.length;c<l;c++)d=e[c],d.fn.apply(d.ctx,b.value);return!0},e=function(){if(0!==b._state)return!1;
  q&&(f=k?a.promise.value:a.value);h.reject.apply(h,f||arguments);return!0});if(q){f=k?a.promise.value:a.value;if(a.isRejected())return this.reject.apply(this,f),this;if(a.isResolved()){b._state=1;b.value=f;e=b._callbacks.done;c=0;for(l=e.length;c<l;c++)d=e[c],d.fn.apply(d.ctx,b.value);return this}try{a.then(d,e)}catch(t){this.isPending()&&this.reject(t)}return this}if(p){try{a.then(d,e)}catch(u){this.isPending()&&this.reject(u)}return this}b._state=1;b.value=arguments;e=b._callbacks.done;c=0;for(l=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        e.length;c<l;c++)d=e[c],d.fn.apply(d.ctx,b.value);return this};c.done=function(a){var b=this.promise;a instanceof g?b.done(function(){a.resolve.apply(a,arguments)}):b.done.apply(b,arguments);return this};c.fail=function(a){var b=this.promise;a instanceof g?b.fail(function(){a.reject.apply(a,arguments)}):b.fail.apply(b,arguments);return this};c.isPending=function(){return 0===this.promise._state};c.isRejected=function(){return 2===this.promise._state};c.isResolved=function(){return 1===this.promise._state};
  c.then=function(){var a=this.promise;return a.then.apply(a,arguments)};g.isPromise=function(a){return a instanceof m||a instanceof g};g.isDeferred=function(a){return a instanceof g};g.when=function(a){for(var b=new g,c,d=a.length,e=[],h=[],l=function(){var a=h.indexOf(this.uid);e[a]=arguments;d-=1;0===d&&b.resolve.apply(b,e)},m=function(a){b.reject(a)},k=0,n=a.length;k<n;k++){c=a[k];c=c.promise||c;h.push(c.uid);if(2===c._state)return b.reject(c.value).promise;c.done(l).fail(m)}return b.promise};"object"===
    typeof module&&"object"===typeof module.exports?module.exports=g:"function"===typeof define&&define.amd?define("Deferred",[],function(){return g}):"object"===typeof window&&(window.Deferred=g)})();