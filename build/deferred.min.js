(function(k){var n=function(){this.value=[];this._state=0;this._callbacks={done:[],fail:[]}},f=n.prototype;f.always=function(a){a instanceof g?this.done(function(){a.resolve.apply(a,arguments)}).fail(function(){a.reject.apply(a,arguments)}):this.done.apply(this,arguments).fail.apply(this,arguments);return this};f.done=function(a,b){var d=this._state,c=a instanceof g;b=b!==k?b:this;if(1===d)return c?a.resolve.apply(a,this.value):a.apply(b,this.value),this;0===d&&(c?this.done(function(){a.resolve.apply(a,
  arguments)}):this._callbacks.done.push({fn:a,ctx:b}));return this};f.fail=function(a,b){var d=this._state,c=a instanceof g;b=b!==k?b:this;if(2===d)return c?a.reject.apply(a,this.value):a.apply(b,this.value),this;0===d&&(c?this.fail(function(){a.reject.apply(a,arguments)}):this._callbacks.fail.push({fn:a,ctx:b}));return this};f.isPending=function(){return 0===this._state};f.isRejected=function(){return 2===this._state};f.isResolved=function(){return 1===this._state};f.then=function(a,b,d){var c=arguments[arguments.length-
  1],e=new g;c&&"function"!==typeof c&&(d=c);d=d!==k?d:this;"function"===typeof a?this.done(function(){var b,c;try{b=a.apply(d,arguments)}catch(g){c=g}c!==k?e.reject(c):b!==k&&e.resolve(b)}):1===this._state&&e.resolve.apply(e,this.value);"function"===typeof b?this.fail(function(){var a,c;try{a=b.apply(d,arguments)}catch(g){c=g}c!==k?e.reject(c):a!==k&&e.resolve(a)}):2===this._state&&e.reject.apply(e,this.value);return e.promise};var r=0,g=function(){this.uid=r++;this.promise=new n;this.promise.uid=
  this.uid},f=g.prototype;f.reject=function(){var a=this.promise;if(0!==a._state)return this;a._state=2;a.value=arguments;for(var b=a._callbacks.fail,d,c=0,e=b.length;c<e;c++)d=b[c],d.fn.apply(d.ctx,a.value);return this};f.resolve=function(a){var b=this.promise,d,c,e,l,f,k=this;if(0!==b._state)return this;if(a===this||a===b)return c=new TypeError("Promise and argument refer to the same object"),this.reject(c),this;var h=a instanceof g,m=a instanceof n,q=h||m,p=typeof a;if(null!==a&&("object"===p||"function"===
  p))try{var s;s=h?a.promise.then:a.then}catch(r){return this.reject(r),this}p="function"===typeof s;m=m?0===a._state:h?0===a.promise._state:!1;!p||q&&!m||(c=function(){if(0!==b._state)return!1;q&&(d=h?a.promise.value:a.value);b._state=1;b.value=d||Array.prototype.slice.call(arguments);var c,e=b._callbacks.done;l=0;for(f=e.length;l<f;l++)c=e[l],c.fn.apply(c.ctx,b.value);return!0},e=function(){if(0!==b._state)return!1;q&&(d=h?a.promise.value:a.value);k.reject.apply(k,d||arguments);return!0});if(q){d=
  h?a.promise.value:a.value;m=h?a.promise._state:a._state;if(2===m)return this.reject.apply(this,d),this;if(1===m){b._state=1;b.value=d;e=b._callbacks.done;l=0;for(f=e.length;l<f;l++)c=e[l],c.fn.apply(c.ctx,b.value);return this}try{h?a.promise.then(c,e):a.then(c,e)}catch(t){0===this.promise._state&&this.reject(t)}return this}if(p){try{h?a.promise.then(c,e):a.then(c,e)}catch(u){0===this.promise._state&&this.reject(u)}return this}b._state=1;b.value=arguments;e=b._callbacks.done;l=0;for(f=e.length;l<f;l++)c=
  e[l],c.fn.apply(c.ctx,b.value);return this};g.isPromise=function(a){return a instanceof n||a instanceof g};g.isDeferred=function(a){return a instanceof g};g.when=function(a){for(var b=new g,d,c=a.length,e=[],f=[],k=function(){var a=f.indexOf(this.uid);e[a]=arguments;c-=1;0===c&&b.resolve.apply(b,e)},n=function(a){b.reject(a)},h=0,m=a.length;h<m;h++){d=a[h];d=d.promise||d;f.push(d.uid);if(2===d._state)return b.reject(d.value).promise;d.done(k).fail(n)}return b.promise};"object"===typeof module&&"object"===
  typeof module.exports?module.exports=g:"function"===typeof define&&define.amd?define("Deferred",[],function(){return g}):"object"===typeof window&&(window.Deferred=g)})();
