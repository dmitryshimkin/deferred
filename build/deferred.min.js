(function(l){var q=function(){this.value=[];this._state=0;this._callbacks={done:[],fail:[]}},h=q.prototype;h.always=function(a){a instanceof f?this.done(function(){a.resolve.apply(a,arguments)}).fail(function(){a.reject.apply(a,arguments)}):this.done.apply(this,arguments).fail.apply(this,arguments);return this};h.done=function(a,b){var c=this._state,d=a instanceof f;b=b!==l?b:this;if(1===c)return d?a.resolve.apply(a,this.value):a.apply(b,this.value),this;0===c&&(d?this.done(function(){a.resolve.apply(a,
  arguments)}):this._callbacks.done.push({fn:a,ctx:b}));return this};h.fail=function(a,b){var c=this._state,d=a instanceof f;b=b!==l?b:this;if(2===c)return d?a.reject.apply(a,this.value):a.apply(b,this.value),this;0===c&&(d?this.fail(function(){a.reject.apply(a,arguments)}):this._callbacks.fail.push({fn:a,ctx:b}));return this};h.isPending=function(){return 0===this._state};h.isRejected=function(){return 2===this._state};h.isResolved=function(){return 1===this._state};h.then=function(a,b,c){var d=arguments[arguments.length-
  1],e=new f;d&&"function"!==typeof d&&(c=d);c=c!==l?c:this;"function"===typeof a?this.done(function(){var b,d;try{b=a.apply(c,arguments)}catch(f){d=f}d!==l?e.reject(d):b!==l&&e.resolve(b)}):1===this._state&&e.resolve.apply(e,this.value);"function"===typeof b?this.fail(function(){var a,d;try{a=b.apply(c,arguments)}catch(f){d=f}d!==l?e.reject(d):a!==l&&e.resolve(a)}):2===this._state&&e.reject.apply(e,this.value);return e.promise};var s=0,n=Array.prototype.slice,f=function(){this.uid=s++;this.promise=
  new q;this.promise.uid=this.uid},h=f.prototype;h.reject=function(){var a=this.promise;if(0!==a._state)return this;a._state=2;a.value=n.call(arguments);for(var b=a._callbacks.fail,c,d=0,e=b.length;d<e;d++)c=b[d],c.fn.apply(c.ctx,a.value);return this};h.resolve=function(a){var b=this.promise,c,d,e,g,h,l=this;if(0!==b._state)return this;if(a===this||a===b)return d=new TypeError("Promise and argument refer to the same object"),this.reject(d),this;var k=a instanceof f,m=a instanceof q,r=k||m,p=typeof a;
  if(null!==a&&("object"===p||"function"===p))try{var t;t=k?a.promise.then:a.then}catch(s){return this.reject(s),this}p="function"===typeof t;m=m?0===a._state:k?0===a.promise._state:!1;!p||r&&!m||(d=function(){if(0!==b._state)return!1;r&&(c=k?a.promise.value:a.value);b._state=1;b.value=c||Array.prototype.slice.call(arguments);var d,e=b._callbacks.done;g=0;for(h=e.length;g<h;g++)d=e[g],d.fn.apply(d.ctx,b.value);return!0},e=function(){if(0!==b._state)return!1;r&&(c=k?a.promise.value:a.value);l.reject.apply(l,
    c||arguments);return!0});if(r){c=k?a.promise.value:a.value;m=k?a.promise._state:a._state;if(2===m)return this.reject.apply(this,c),this;if(1===m){b._state=1;b.value=c;e=b._callbacks.done;g=0;for(h=e.length;g<h;g++)d=e[g],d.fn.apply(d.ctx,b.value);return this}try{k?a.promise.then(d,e):a.then(d,e)}catch(u){0===this.promise._state&&this.reject(u)}return this}if(p){try{k?a.promise.then(d,e):a.then(d,e)}catch(v){0===this.promise._state&&this.reject(v)}return this}b._state=1;b.value=n.call(arguments);e=
    b._callbacks.done;g=0;for(h=e.length;g<h;g++)d=e[g],d.fn.apply(d.ctx,b.value);return this};f.isPromise=function(a){return a instanceof q||a instanceof f};f.isDeferred=function(a){return a instanceof f};f.when=function(a){for(var b=new f,c,d=a.length,e=[],g=[],h=function(){var a=g.indexOf(this.uid);e[a]=n.call(arguments);d-=1;0===d&&b.resolve.apply(b,e)},l=function(){var a=n.call(arguments),c=g.indexOf(this.uid);a.push(c);b.reject.apply(b,a)},k=0,m=a.length;k<m;k++){c=a[k];c instanceof f&&(c=c.promise);
  g.push(c.uid);if(2===c._state)return a=g.indexOf(c.uid),c=c.value,c.push(a),b.reject.apply(b,c).promise;c.done(h).fail(l)}return b.promise};f.any=function(a){for(var b=new f,c,d=a.length,e=[],g=[],h=function(){var a=n.call(arguments),c=g.indexOf(this.uid);a.push(c);b.resolve.apply(b,a)},l=function(){var a=g.indexOf(this.uid);e[a]=n.call(arguments);d-=1;0===d&&b.reject.apply(b,e)},k=0,m=a.length;k<m;k++){c=a[k];c instanceof f&&(c=c.promise);g.push(c.uid);if(1===c._state)return a=g.indexOf(c.uid),c=
  c.value,c.push(a),b.resolve.apply(b,c).promise;c.done(h).fail(l)}return b.promise};"object"===typeof module&&"object"===typeof module.exports?module.exports=f:"function"===typeof define&&define.amd?define("Deferred",[],function(){return f}):"object"===typeof window&&(window.Deferred=f)})();
