<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Performance test</title>
    <script src="lib/deferred.js"></script>
    <script src="lib/jquery.js"></script>
    <script src="lib/kew.js"></script>
    <script src="lib/q.js"></script>
    <script src="lib/rsvp.js"></script>
    <script src="lib/rubaxa-deferred.js"></script>
    <script src="lib/vow.js"></script>
  </head>
  <body>
    <div id="result"></div>
    <script>
      var showResult = function (name, t) {
        var target = document.getElementById('result');
        target.innerHTML = name + ': ' + t.toFixed(3);
      };

      var done = function () {};

      var tests = {
        deferred: function () {
          var t = performance.now();

          var i = 10000;
          while (i--) {
            var d = new Deferred();
            d.promise.then(done);
            d.resolve();
          }

          t = performance.now() - t;

          showResult('Deferred', t);
        },

        kew: function () {
          var t = performance.now();

          var i = 10000;
          while (i--) {
            var resolve;
            var d = new kew.defer();
            d.then(done);
            d.resolve();
          }

          t = performance.now() - t;
          showResult('kew', t);
        },

        jquery: function () {
          var t = performance.now();

          var i = 10000;
          while (i--) {
            var d = $.Deferred();
            d.then(done);
            d.resolve();
          }

          t = performance.now() - t;
          showResult('jQuery', t);
        },

        promise: function () {
          var t = performance.now();

          var i = 10000;
          while (i--) {
            var resolve;
            var d = new Promise(function (resolve) {
              resolve();
            });
            d.then(done);
          }

          t = performance.now() - t;
          showResult('Promise', t);
        },

        q: function () {
          var t = performance.now();

          var i = 10000;
          while (i--) {
            var resolve;
            var d = new Q.defer();
            d.promise.then(done);
            d.resolve();
          }

          t = performance.now() - t;
          showResult('Q', t);
        },

        rsvp: function () {
          var t = performance.now();

          var i = 10000;
          while (i--) {
            var resolve;
            var d = new RSVP.Promise(function (resolve) {
              resolve();
            });
            d.then(done);
          }

          t = performance.now() - t;
          showResult('RSVP', t);
        },

        rubaxa: function () {
          var t = performance.now();

          var i = 10000;
          while (i--) {
            var resolve;
            var d = new RubaxaDeferred();
            d.then(done);
            d.resolve();
          }

          t = performance.now() - t;
          showResult('Rubaxa', t);
        },

        vow: function () {
          var t = performance.now();

          var i = 10000;
          while (i--) {
            var resolve;
            var d = new vow.Deferred();
            d.promise().then(done);
            d.resolve();
          }

          t = performance.now() - t;
          showResult('Vow', t);
        }
      };

      var testName = window.location.search.replace('?', '');

      if (tests[testName]) {
        tests[testName]();
      }
    </script>
  </body>
</html>
